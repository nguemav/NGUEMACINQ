<html><head><base href="https://nguemav.github.io/NGUEMACINQ/"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Web TV - &#xc9;cran Large</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
    background-color: #1a1a1a;
    color: #fff;
  }
  .container {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  .main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  .channels {
    width: 20%;
    background-color: #2c2c2c;
    padding: 10px;
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease;
  }
  h1 {
    text-align: center;
    color: orange;
    font-size: 1.2em;
    margin: 10px 0;
    flex-shrink: 0;
  }
  .search-container {
    margin-bottom: 10px;
    position: relative;
    flex-shrink: 0;
  }
  #channelList::-webkit-scrollbar {
    display: none; /* For Chrome, Safari and Opera */
  }
  #channelList {
    -ms-overflow-style: none;  /* For Internet Explorer and Edge */
    scrollbar-width: none;  /* For Firefox */
    overflow-y: auto;
    flex-grow: 1;
  }
  .player {
    width: 80%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: #000;
    transition: width 0.3s ease;
    position: relative; /* Add this */
    padding-bottom: 50px; /* Add padding to make room for the import button */
  }
  .channel-item {
    padding: 10px;
    margin-bottom: 5px;
    background-color: #3a3a3a;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 0.9em;
    font-weight: bold;
    display: flex;
    align-items: center;
  }
  .channel-item:hover {
    background-color: #4a4a4a;
  }
  .channel-logo {
    width: 30px;
    height: 30px;
    margin-right: 10px;
    object-fit: contain;
  }
  .channel-item .play-icon {
    display: none;
    margin-left: auto;
    width: 20px;
    height: 20px;
    fill: orange; /* Changed from #e50914 to orange */
  }
  .channel-item.playing .play-icon {
    display: block;
  }
  #videoPlayer {
    width: 100%;
    height: 100%;
    max-height: calc(100vh - 120px);
    background: #000;
    object-fit: contain;
  }
  .toggleSidebar {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background-color: rgba(0,0,0,0.5);
    color: white;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
  }
  .hidden {
    width: 0 !important;
    padding: 0 !important;
    overflow: hidden;
  }
  #searchInput {
    width: calc(100% - 40px);
    padding: 8px 30px 8px 10px;
    border: none;
    border-radius: 5px;
    background-color: #3a3a3a;
    color: #fff;
    font-size: 0.9em;
    box-sizing: border-box;
  }
  #searchInput:focus {
    outline: none;
    background-color: #4a4a4a;
  }
  .search-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    fill: #fff;
    pointer-events: none;
  }
  .context-menu {
    display: none;
    position: absolute;
    background-color: #3a3a3a;
    border: 1px solid #555;
    border-radius: 5px;
    padding: 5px 0;
    z-index: 1000;
  }
  .context-menu-item {
    padding: 5px 20px;
    cursor: pointer;
  }
  .context-menu-item:hover {
    background-color: #4a4a4a;
  }
  .welcome-message {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #1a1a1a;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    opacity: 1;
    transition: opacity 0.5s ease-in-out;
  }
  .welcome-message h2 {
    color: orange;
    font-size: 2em;
    text-align: center;
    padding: 20px;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }
  .film-section {
    position: fixed;
    bottom: 10px;
    right: 10px;
    font-size: 14px;
    font-weight: bold;
    color: #000000;
    z-index: 1000;
    cursor: pointer;
    display: flex;
    align-items: center;
    background-color: orange;
    padding: 5px 10px; /* Changed padding to match import-button */
    border-radius: 5px; 
    height: 18px; /* Added explicit height to match import-button */
    line-height: 18px; /* Added line-height for vertical centering */
  }
  .arrow-icon {
    width: 16px; /* Reduced size slightly */
    height: 16px;
    fill: #000000; /* Changed to black */
    margin-left: 5px;
    animation: scintillate 1s infinite alternate;
  }
  @keyframes scintillate {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  .film-menu {
    display: none;
    position: fixed;
    bottom: 40px;
    right: 10px;
    background-color: #2c2c2c;
    border-radius: 5px;
    padding: 10px;
    z-index: 1001;
  }
  .film-menu a {
    display: block;
    color: yellow;
    text-decoration: none;
    padding: 5px 10px;
  }
  .film-menu a:hover {
    background-color: #3a3a3a;
  }
  .import-m3u-section {
    position: fixed;
    bottom: 10px;
    right: 200px; /* Keep this value */
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    z-index: 1000;
    cursor: pointer;
    display: flex;
    align-items: center;
    background-color: orange;
    padding: 5px 10px;
    border-radius: 5px;
    height: 18px;
    line-height: 18px;
  }
  .import-button {
    margin-left: 10px;
    padding: 5px 10px;
    color: #fff;
    border-radius: 5px;
    cursor: pointer;
    border-left: 1px solid #1a1a1a; /* Added a separator */
  }
  .import-button:hover {
    background-color: #ffa500;
  }
  .import-link-m3u-section {
    position: fixed;
    bottom: 10px;
    right: 600px; /* Changed from 400px to 600px to move it left by ~2cm */
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    z-index: 1000;
    cursor: pointer;
    display: flex;
    align-items: center;
    background-color: orange;
    padding: 5px 10px;
    border-radius: 5px;
    height: 18px;
    line-height: 18px;
  }
  .import-link-button {
    margin-left: 10px;
    padding: 5px 10px;
    color: #fff;
    border-radius: 5px;
    cursor: pointer;
    border-left: 1px solid #1a1a1a;
  }
  .import-link-button:hover {
    background-color: #ffa500;
  }
  .channel-item span {
    color: orange;
    font-size: 1.2em;
    font-weight: bold;
  }
  .player {
    background-color: #000;
    position: relative;
    overflow: hidden;
  }
  .nguema5tv-logo-3d {
    position: absolute;
    top: 18px;
    left: 18px;
    z-index: 1100;
    width: 220px;
    height: 90px;
    display: block;
    background: #fff8e1;
    border: 2px solid orange;
    box-shadow: 0 0 10px #0008;
    pointer-events: auto;
  }
  .fullscreen-btn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 1200;
    background: rgba(255, 165, 0, 0.9);
    color: #1a1a1a;
    border: none;
    border-radius: 5px;
    padding: 8px 16px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background 0.2s;
  }
  .fullscreen-btn:hover {
    background: #ffa500;
  }
  .player.fullscreen {
    position: fixed !important;
    top: 0;
    left: 0;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 3000;
    background: #000;
  }
  .nguema5tv-logo-3d.fullscreen-logo {
    position: fixed !important;
    top: 30px !important;
    left: 30px !important;
    z-index: 4000 !important;
    width: 180px;
    height: 70px;
    pointer-events: none;
  }
  .fullscreen-btn.fullscreen-btn-on {
    position: fixed !important;
    bottom: 30px !important;
    right: 30px !important;
    z-index: 4100 !important;
  }
  .nguema5tv-text-3d {
    position: absolute;
    top: 18px;
    left: 18px;
    z-index: 1100;
    font-size: 1.3em;
    font-style: italic;
    font-weight: bold;
    color: #b0b0b0;
    letter-spacing: 2px;
    text-shadow: 1px 1px 2px #fff, 2px 2px 8px #888, 0 0 10px #888, 0 2px 0 #666, 0 4px 0 #444;
    font-family: 'Arial Black', Arial, sans-serif;
    background: linear-gradient(90deg, #b0b0b0 0%, #e0e0e0 50%, #888 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-fill-color: transparent;
    filter: drop-shadow(0 2px 6px #222);
    pointer-events: none;
  }
  .nguema-rect {
    display: inline-block;
    background: #252526;
    color: #fff;
    border-radius: 6px;
    padding: 2px 10px 2px 10px;
    margin-right: 6px;
    box-shadow: 0 2px 6px #1118;
    -webkit-text-fill-color: #fff;
    text-fill-color: #fff;
    -webkit-background-clip: border-box;
    background-clip: border-box;
  }
  .player.fullscreen #videoPlayer {
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    object-fit: contain;
  }
</style>
</head>
<body>
<div id="welcomeMessage" class="welcome-message">
  <h2>BIENVENUE SUR LA PLATE-FORME NGUEMA5TV</h2>
</div>
<button id="toggleSidebar">&#x2630;</button>
<div class="container">
  <div class="main-content">
    <div class="channels" id="sidebar">
      <h1>Cha&#xee;nes TV</h1>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Rechercher une cha&#xee;ne...">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
      </div>
      <div id="channelList"></div>
    </div>
    <div class="player" id="playerContainer">
      <div class="nguema5tv-logo-3d" style="display: flex; align-items: center; justify-content: center; background: none; border: none; box-shadow: none;">
        <svg width="860" height="154" viewBox="0 0 860 154" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="silverGradient" x1="0" y1="0" x2="860" y2="0" gradientUnits="userSpaceOnUse">
              <stop stop-color="#b0b0b0"/>
              <stop offset="0.5" stop-color="#e0e0e0"/>
              <stop offset="1" stop-color="#888"/>
            </linearGradient>
            <linearGradient id="goldGradient" x1="570" y1="0" x2="670" y2="0" gradientUnits="userSpaceOnUse">
              <stop stop-color="#ffd700"/>
              <stop offset="1" stop-color="#ffa500"/>
            </linearGradient>
            <filter id="shadow" x="-20" y="-20" width="900" height="200">
              <feDropShadow dx="0" dy="8" stdDeviation="8" flood-color="#222" flood-opacity="0.7"/>
            </filter>
          </defs>
          <text x="30" y="120" font-size="120" font-family="Arial Black, Arial, sans-serif" font-weight="bold"
                fill="url(#silverGradient)" stroke="#fff8e1" stroke-width="4" filter="url(#shadow)">
            NGUEMA
          </text>
          <text x="570" y="120" font-size="120" font-family="Arial Black, Arial, sans-serif" font-weight="bold"
                fill="url(#goldGradient)" stroke="#fff8e1" stroke-width="4" filter="url(#shadow)">
            5
          </text>
          <text x="650" y="120" font-size="120" font-family="Arial Black, Arial, sans-serif" font-weight="bold"
                fill="url(#silverGradient)" stroke="#fff8e1" stroke-width="4" filter="url(#shadow)">
            TV
          </text>
        </svg>
      </div>
      <video id="videoPlayer" controls crossorigin="anonymous" playsinline preload="auto">
        <source src type="application/x-mpegURL">
        <source src type="video/mp4">
        <source src type="video/webm">
        <source src type="video/mkv">
        <source src type="video/ogg">
        <source src type="video/avi">
        <source src type="video/mpeg">
        <source src type="video/mpg">
        <source src type="video/ts">
        <source src type="video/x-matroska">
        <source src type="video/x-msvideo">
        <source src type="video/x-flv">
        <source src type="video/divx">
        <source src type="video/h264">
        Votre navigateur ne supporte pas la lecture de vidéos.
      </video>
      <button class="fullscreen-btn" id="fullscreenBtn" title="Plein écran">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 4H9V2H2V9H4V4ZM20 4V9H22V2H15V4H20ZM4 20V15H2V22H9V20H4ZM20 20H15V22H22V15H20V20Z" fill="#fff"/>
        </svg>
      </button>
    </div>
  </div>
  <div class="import-m3u-section">
    <span>Importer fichier M3U</span>
    <input type="file" id="m3uFileInput" accept=".m3u,.m3u8" style="display: none;">
    <label for="m3uFileInput" class="import-button">Importer</label>
  </div>
  <div class="import-link-m3u-section">
    <span>Importer lien M3U</span>
    <div class="import-link-button" id="importM3uLink">Importer</div>
  </div>
</div>

<div id="contextMenu" class="context-menu">
  <div class="context-menu-item" id="addLogo">Ajouter un logo</div>
  <div class="context-menu-item" id="renameChannel">Renommer la cha&#xee;ne</div>
  <div class="context-menu-item" id="deleteChannel">Supprimer la cha&#xee;ne</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
<script>document.addEventListener('DOMContentLoaded', function () {
  const videoPlayer = document.getElementById('videoPlayer');
  const sidebar = document.getElementById('sidebar');
  const playerContainer = document.getElementById('playerContainer');
  const toggleButton = document.getElementById('toggleSidebar');
  const channelList = document.getElementById('channelList');
  const searchInput = document.getElementById('searchInput');
  const contextMenu = document.getElementById('contextMenu');
  const addLogoItem = document.getElementById('addLogo');
  const renameChannelItem = document.getElementById('renameChannel');
  const deleteChannelItem = document.getElementById('deleteChannel');
  const welcomeMessage = document.getElementById('welcomeMessage');
  const m3uFileInput = document.getElementById('m3uFileInput');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  // Correction : le logo SVG n'a pas la classe .nguema5tv-text-3d, donc on ne l'utilise pas ici
  // let nguemaLogo = playerContainer.querySelector('.nguema5tv-text-3d');
  let savedLogos = JSON.parse(localStorage.getItem('channelLogos')) || {};
  let currentlyPlayingItem = null;

  function saveCurrentPlaylist() {
    const channelItems = Array.from(channelList.getElementsByClassName('channel-item'));
    const playlist = channelItems.map(item => ({
      name: item.querySelector('span').textContent,
      url: item.getAttribute('data-src'),
      logo: item.querySelector('.channel-logo') ? item.querySelector('.channel-logo').src : ''
    }));
    localStorage.setItem('savedPlaylist', JSON.stringify(playlist));
    localStorage.setItem('channelLogos', JSON.stringify(savedLogos));
  }
  function loadSavedPlaylist() {
    const savedPlaylist = JSON.parse(localStorage.getItem('savedPlaylist'));
    if (savedPlaylist) {
      channelList.innerHTML = '';
      savedPlaylist.forEach(channel => {
        addChannelItem(channel.name, channel.url, channel.logo);
      });
    }
  }
  function toggleSidebar() {
    sidebar.classList.toggle('hidden');
    if (sidebar.classList.contains('hidden')) {
      playerContainer.style.width = '100%';
    } else {
      playerContainer.style.width = '80%';
    }
  }
  toggleButton.addEventListener('click', toggleSidebar);

  function playChannel(src) {
    const ext = src.split('.').pop().toLowerCase().split('?')[0];
    const ffmpegExts = ['mkv', 'avi', 'mpg', 'mpeg', 'divx', 'ts', 'webm'];
    
    if (ffmpegExts.includes(ext)) {
        playWithFFmpeg(src).catch(err => {
            console.error(`Erreur dans playWithFFmpeg pour ${src}:`, err);
        });
    } else {
        _playChannelInternal(src);
    }
  }

  function _playChannelInternal(src) {
    videoPlayer.src = '';
    if (window.hls) {
      window.hls.destroy();
    }
    // Détection de l'extension du flux
    const ext = src.split('.').pop().toLowerCase().split('?')[0];
    const hlsExts = ['m3u8'];
    if (hlsExts.includes(ext) && Hls.isSupported()) {
      const hls = new Hls({
        debug: false,
        enableWorker: true,
        enableMP2TSDemuxing: true,
        progressive: true,
        lowLatencyMode: true,
        backBufferLength: 60,
        liveBackBufferLength: 90,
        liveDurationInfinity: true,
        highBufferWatchdogPeriod: 3,
        maxBufferLength: 120,
        maxMaxBufferLength: 600,
        manifestLoadingTimeOut: 20000,
        manifestLoadingMaxRetry: 3,
        levelLoadingTimeOut: 20000,
        levelLoadingMaxRetry: 3,
        fragLoadingTimeOut: 30000,
        fragLoadingMaxRetry: 4,
        appendErrorMaxRetry: 5,
        startLevel: -1,
        abrEwmaDefaultEstimate: 500000,
        abrBandWidthFactor: 0.85,
        abrBandWidthUpFactor: 0.65,
        abrMaxWithRealBitrate: true,
        forceKeyFrameOnDiscontinuity: true,
        maxBufferHole: 0.5,
        maxFragLookUpTolerance: 0.25,
        nudgeOffset: 0.1,
        nudgeMaxRetry: 3,
        maxStarvationDelay: 4,
        maxSeekHole: 2,
        stretchShortVideoTrack: true,
        maxAudioFramesDrift: 1,
        enableSoftwareAES: true,
        enableDateRangeMetadataCues: true,
        enableEmsgMetadataCues: true,
        enableID3MetadataCues: true,
        enableWebVTT: true,
        enableIMSC1: true,
        enableCEA708Captions: true,
        captionsTextTrack1Label: 'French',
        captionsTextTrack1LanguageCode: 'fr',
        captionsTextTrack2Label: 'English',
        captionsTextTrack2LanguageCode: 'en',
        maxBufferSize: 60 * 1000 * 1000
      });
      window.hls = hls;
      hls.loadSource(src);
      hls.attachMedia(videoPlayer);
      hls.on(Hls.Events.MANIFEST_PARSED, function () {
        videoPlayer.play().then(() => {
          console.log("Playback started successfully");
        }).catch(function (error) {
          console.log("Play failed:", error);
          videoPlayer.muted = true;
          return videoPlayer.play();
        });
      });
      hls.on(Hls.Events.ERROR, function (event, data) {
        if (data.fatal) {
          switch (data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              console.log("Network error, trying to recover...");
              hls.startLoad();
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              console.log("Media error, trying to recover...");
              hls.recoverMediaError();
              break;
            default:
              console.log("Unrecoverable error");
              hls.destroy();
              break;
          }
        } else {
          switch(data.details) {
            case Hls.ErrorDetails.FRAG_PARSING_ERROR:
                console.error("Fragment parsing error:", data.reason);
                hls.recoverMediaError();
                break;
            case Hls.ErrorDetails.BUFFER_STALLED_ERROR:
              console.log("Buffer stalled, attempting to recover...");
              hls.trigger(Hls.Events.BUFFER_FLUSHING);
              break;
            case Hls.ErrorDetails.BUFFER_FULL_ERROR:
              console.log("Buffer full, flushing...");
              hls.trigger(Hls.Events.BUFFER_FLUSHING);
              break;
            default:
              console.log("Non-fatal error:", data.details);
          }
        }
      });
      hls.on(Hls.Events.FRAG_LOADED, function(event, data) {
        console.log("Fragment loaded successfully");
      });
      hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
        console.log("Quality level switched to " + data.level);
      });
      hls.on(Hls.Events.BUFFER_APPENDED, function(event, data) {
        console.log("Buffer appended");
      });
      hls.on(Hls.Events.FPS_DROP, function(event, data) {
        console.log("FPS drop detected");
        if (data.currentDropped > 10) {
          hls.nextLevel = hls.currentLevel - 1;
        }
      });
    } else {
      // Pour tous les autres formats, on laisse le navigateur gérer
      videoPlayer.src = src;
      videoPlayer.load();
      videoPlayer.addEventListener('loadedmetadata', function onLoaded() {
        videoPlayer.removeEventListener('loadedmetadata', onLoaded);
        videoPlayer.play().catch(function (error) {
          console.log("Play failed:", error);
          videoPlayer.muted = true;
          videoPlayer.play();
        });
      });
    }
    if (window.innerWidth <= 768) {
      toggleSidebar();
    }
    if (currentlyPlayingItem) {
      currentlyPlayingItem.classList.remove('playing');
    }
    const currentItem = document.querySelector(`.channel-item[data-src="${src}"]`);
    if (currentItem) {
      currentItem.classList.add('playing');
      currentlyPlayingItem = currentItem;
    }
  }

  function addChannelItem(name, src, logoUrl) {
    const channelItem = document.createElement('div');
    channelItem.className = 'channel-item';
    const savedLogoUrl = savedLogos[src] || logoUrl;
    if (savedLogoUrl) {
      const logo = document.createElement('img');
      logo.src = savedLogoUrl;
      logo.alt = `Logo ${name}`;
      logo.className = 'channel-logo';
      channelItem.appendChild(logo);
    }
    const channelName = document.createElement('span');
    channelName.textContent = name;
    channelItem.appendChild(channelName);
    const playIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    playIcon.classList.add('play-icon');
    playIcon.setAttribute('viewBox', '0 0 24 24');
    playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
    channelItem.appendChild(playIcon);
    channelItem.setAttribute('data-src', src);
    channelItem.addEventListener('click', function () {
      playChannel(src);
    });
    channelList.appendChild(channelItem);
    saveCurrentPlaylist();
  }
  function loadChannelsFromM3U(url) {
    fetch(url).then(response => response.text()).then(data => {
      channelList.innerHTML = '';
      const lines = data.split('\n');
      let currentName = '';
      let currentUrl = '';
      let currentLogo = '';
      lines.forEach(line => {
        if (line.startsWith('#EXTINF:')) {
          const match = line.match(/tvg-logo="([^"]*)"[^,]*,(.+)/);
          if (match) {
            currentLogo = match[1];
            currentName = match[2].trim();
          } else {
            const nameParts = line.split(',');
            if (nameParts.length > 1) {
              currentName = nameParts[1].trim();
            }
          }
        } else if (line.startsWith('http')) {
          currentUrl = line.trim();
          addChannelItem(currentName, currentUrl, currentLogo);
          currentName = '';
          currentUrl = '';
          currentLogo = '';
        }
      });
      saveCurrentPlaylist();
    }).catch(error => console.error('Erreur lors du chargement du fichier M3U:', error));
  }
  function parseM3UAndAddChannels(content) {
    const lines = content.split('\n');
    let currentName = '';
    let currentUrl = '';
    let currentLogo = '';
    channelList.innerHTML = '';
    lines.forEach(line => {
      if (line.startsWith('#EXTINF:')) {
        const match = line.match(/tvg-logo="([^"]*)"[^,]*,(.+)/);
        if (match) {
          currentLogo = match[1];
          currentName = match[2].trim();
        } else {
          const nameParts = line.split(',');
          if (nameParts.length > 1) {
            currentName = nameParts[1].trim();
          }
        }
      } else if (line.startsWith('http')) {
        currentUrl = line.trim();
        addChannelItem(currentName, currentUrl, currentLogo);
        currentName = '';
        currentUrl = '';
        currentLogo = '';
      }
    });
    saveCurrentPlaylist();
  }
  loadSavedPlaylist();
  channelList.addEventListener('click', function (e) {
    if (e.target.classList.contains('channel-item') || e.target.closest('.channel-item')) {
      const channelItem = e.target.classList.contains('channel-item') ? e.target : e.target.closest('.channel-item');
      playChannel(channelItem.getAttribute('data-src'));
    }
  });
  searchInput.addEventListener('input', function () {
    const searchTerm = this.value.toLowerCase();
    const channelItems = channelList.getElementsByClassName('channel-item');
    Array.from(channelItems).forEach(item => {
      const channelName = item.textContent.toLowerCase();
      if (channelName.includes(searchTerm)) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });
  });
  function addLogoToChannel(channelItem) {
    const logoUrl = prompt("Entrez l'URL du logo de la chaîne :");
    if (logoUrl) {
      let logo = channelItem.querySelector('.channel-logo');
      if (!logo) {
        logo = document.createElement('img');
        logo.className = 'channel-logo';
        channelItem.insertBefore(logo, channelItem.firstChild);
      }
      logo.src = logoUrl;
      logo.alt = "Logo de la chaîne";
      const channelSrc = channelItem.getAttribute('data-src');
      savedLogos[channelSrc] = logoUrl;
      localStorage.setItem('channelLogos', JSON.stringify(savedLogos));
      saveCurrentPlaylist();
    }
  }
  function renameChannel(channelItem) {
    const nameSpan = channelItem.querySelector('span');
    const newName = prompt("Entrez le nouveau nom de la chaîne :", nameSpan.textContent);
    if (newName) {
      nameSpan.textContent = newName;
      saveCurrentPlaylist();
    }
  }
  function deleteChannel(channelItem) {
    if (confirm("Êtes-vous sûr de vouloir supprimer cette chaîne ?")) {
      const channelSrc = channelItem.getAttribute('data-src');
      delete savedLogos[channelSrc];
      localStorage.setItem('channelLogos', JSON.stringify(savedLogos));
      channelItem.remove();
      saveCurrentPlaylist();
    }
  }
  channelList.addEventListener('contextmenu', function (e) {
    e.preventDefault();
    if (e.target.classList.contains('channel-item') || e.target.parentElement.classList.contains('channel-item')) {
      const channelItem = e.target.classList.contains('channel-item') ? e.target : e.target.parentElement;
      contextMenu.style.display = 'block';
      contextMenu.style.left = `${e.pageX}px`;
      contextMenu.style.top = `${e.pageY}px`;
      contextMenu.setAttribute('data-target', channelItem.getAttribute('data-src'));
    }
  });
  document.addEventListener('click', function () {
    contextMenu.style.display = 'none';
  });
  addLogoItem.addEventListener('click', function () {
    const targetSrc = contextMenu.getAttribute('data-target');
    const channelItem = document.querySelector(`.channel-item[data-src="${targetSrc}"]`);
    if (channelItem) {
      addLogoToChannel(channelItem);
    }
    contextMenu.style.display = 'none';
  });
  renameChannelItem.addEventListener('click', function () {
    const targetSrc = contextMenu.getAttribute('data-target');
    const channelItem = document.querySelector(`.channel-item[data-src="${targetSrc}"]`);
    if (channelItem) {
      renameChannel(channelItem);
    }
    contextMenu.style.display = 'none';
  });
  deleteChannelItem.addEventListener('click', function () {
    const targetSrc = contextMenu.getAttribute('data-target');
    const channelItem = document.querySelector(`.channel-item[data-src="${targetSrc}"]`);
    if (channelItem) {
      deleteChannel(channelItem);
    }
    contextMenu.style.display = 'none';
  });

  /* NGUEMA5TV FFMPEG JS INTEGRATION START */
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({
    log: true
  });
  let ffmpegLoaded = false;

  async function playWithFFmpeg(src) {
    const loadingOverlay = document.createElement('div');
    loadingOverlay.style.position = 'absolute';
    loadingOverlay.style.top = '0';
    loadingOverlay.style.left = '0';
    loadingOverlay.style.width = '100%';
    loadingOverlay.style.height = '100%';
    loadingOverlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
    loadingOverlay.style.color = 'white';
    loadingOverlay.style.display = 'flex';
    loadingOverlay.style.justifyContent = 'center';
    loadingOverlay.style.alignItems = 'center';
    loadingOverlay.style.zIndex = '5000';
    loadingOverlay.innerHTML = '<h2>Initialisation...</h2>';
    playerContainer.appendChild(loadingOverlay);

    try {
      if (!ffmpegLoaded) {
        loadingOverlay.innerHTML = '<h2>Chargement du moteur de conversion (première utilisation)...</h2>';
        await ffmpeg.load();
        ffmpegLoaded = true;
      }

      const inputFilename = `input.${src.split('.').pop().toLowerCase().split('?')[0]}`;
      const outputFilename = 'output.mp4';
      
      loadingOverlay.innerHTML = '<h2>Téléchargement de la vidéo...</h2>';
      ffmpeg.FS('writeFile', inputFilename, await fetchFile(src));
      
      loadingOverlay.innerHTML = '<h2>Conversion de la vidéo... (ceci peut prendre du temps)</h2>';
      await ffmpeg.run('-i', inputFilename, '-preset', 'ultrafast', '-c:v', 'libx264', '-c:a', 'aac', outputFilename);
      
      loadingOverlay.innerHTML = '<h2>Lecture...</h2>';
      const data = ffmpeg.FS('readFile', outputFilename);
      
      ffmpeg.FS('unlink', inputFilename);
      ffmpeg.FS('unlink', outputFilename);

      if (window.hls) {
        window.hls.destroy();
      }
      const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
      
      // Mettre à jour le lecteur
      if (currentlyPlayingItem) {
        currentlyPlayingItem.classList.remove('playing');
      }
      const currentItem = document.querySelector(`.channel-item[data-src="${src}"]`);
      if (currentItem) {
        currentItem.classList.add('playing');
        currentlyPlayingItem = currentItem;
      }

      videoPlayer.src = url;
      videoPlayer.load();
      videoPlayer.play().catch(e => {
        console.error("Erreur de lecture après conversion:", e);
        videoPlayer.muted = true;
        videoPlayer.play();
      });

    } catch (error) {
        console.error('Erreur avec FFMPEG:', error);
        loadingOverlay.innerHTML = `<h2>Erreur lors de la conversion.</h2><p style="font-size: 12px; white-space: pre-wrap;">${error.message}</p>`;
        setTimeout(() => loadingOverlay.remove(), 5000);
        return;
    } finally {
        if(loadingOverlay.parentElement) {
            loadingOverlay.remove();
        }
    }
  }
  /* NGUEMA5TV FFMPEG JS INTEGRATION END */

  m3uFileInput.addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        parseM3UAndAddChannels(content);
      };
      reader.readAsText(file);
    }
  });
  document.getElementById('importM3uLink').addEventListener('click', function () {
    const m3uUrl = prompt("Entrez l'URL du fichier M3U:");
    if (m3uUrl) {
      loadChannelsFromM3U(m3uUrl);
    }
  });
  function playFirstChannel() {
    const firstChannel = channelList.querySelector('.channel-item');
    if (firstChannel) {
      firstChannel.classList.add('playing');
      currentlyPlayingItem = firstChannel;
    }
  }
  welcomeMessage.style.display = 'flex';
  welcomeMessage.style.opacity = '1';
  setTimeout(() => {
    welcomeMessage.style.opacity = '0';
    setTimeout(() => {
      welcomeMessage.style.display = 'none';
      playFirstChannel();
    }, 500);
  }, 5000);
  fullscreenBtn.addEventListener('click', function () {
    if (!document.fullscreenElement) {
      if (playerContainer.requestFullscreen) {
        playerContainer.requestFullscreen();
      } else if (playerContainer.webkitRequestFullscreen) {
        playerContainer.webkitRequestFullscreen();
      } else if (playerContainer.msRequestFullscreen) {
        playerContainer.msRequestFullscreen();
      }
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
  });

  let fullscreenBtnTimeout;
  function showFullscreenBtn() {
    fullscreenBtn.style.opacity = '1';
    fullscreenBtn.style.pointerEvents = 'auto';
    fullscreenBtn.style.display = 'flex';
    if (fullscreenBtnTimeout) clearTimeout(fullscreenBtnTimeout);
    fullscreenBtnTimeout = setTimeout(() => {
      if (document.fullscreenElement === playerContainer) {
        fullscreenBtn.style.opacity = '0';
        fullscreenBtn.style.pointerEvents = 'none';
        fullscreenBtn.style.display = 'none';
      }
    }, 2000);
  }
  function hideFullscreenBtn() {
    fullscreenBtn.style.opacity = '0';
    fullscreenBtn.style.pointerEvents = 'none';
    fullscreenBtn.style.display = 'none';
  }

  document.addEventListener('fullscreenchange', function () {
    if (document.fullscreenElement === playerContainer) {
      playerContainer.classList.add('fullscreen');
      fullscreenBtn.classList.add('fullscreen-btn-on');
      // Masquer immédiatement le bouton en plein écran
      hideFullscreenBtn();
      // Ajouter l'écouteur de mouvement de souris
      playerContainer.addEventListener('mousemove', showFullscreenBtn);
    } else {
      playerContainer.classList.remove('fullscreen');
      fullscreenBtn.classList.remove('fullscreen-btn-on');
      // Afficher le bouton hors plein écran
      fullscreenBtn.style.opacity = '1';
      fullscreenBtn.style.pointerEvents = 'auto';
      fullscreenBtn.style.display = 'flex';
      // Retirer l'écouteur
      playerContainer.removeEventListener('mousemove', showFullscreenBtn);
      if (fullscreenBtnTimeout) clearTimeout(fullscreenBtnTimeout);
    }
  });
});</script>
</body></html>
